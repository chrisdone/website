<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Haskell Formlets: Composable web form construction and
validation</title>
    <style>
      body {
      max-width: 40em;
      margin: .5in auto;
      font-size: 18px;
      font-family: serif;
      line-height: 1.5;
      }
      pre, code {
      font-size: 16px;
      word-wrap: break-word;
      }
      pre {
      padding-left: 1em;
      line-height: 1.5em;
      border-left: 5px solid #efefef;
      }
      a {
      color: #1a6e8e
      }
      .menu a {
      margin-right: 1em;
      }
      h1,h2,h3,h4,h5,h6 {
      font-family: Helvetica;
      }

      h1 a,h2 a,h3 a,h4 a {
      text-decoration: none;
      color: inherit;
      }

      .post-1,.post-2{
      margin-bottom: 0.5em;
      }

      .author {
      display: none;
      }

      footer {
      margin-top: 1.5em;
      padding-top: 1.5em;
      border-top: 1px solid #ccc;
      margin-bottom: 2em
      }

      footer span {
      display: none;
      }

      img {
      max-width: 100%
      }
      pre.sourceCode span.st {
      color: #366354
      }
      pre.sourceCode span.kw {
      color: #397460
      }
      pre.sourceCode span.fu {
      color: #8f4e8b
      }
      pre.sourceCode span.ot {
      color: #2e659c
      }
      pre.sourceCode span.dt {
      color: #4F4371
      }
      pre.sourceCode span.co {
      color: #666
      }
      @media(max-width:767px){
      body { margin: 1px 4px; }
      h1, h2, .menu { margin: 0; }
      h1 { font-size: 1.5em; }
      h2 { font-size: 1.125em; }
      h3 { font-size: 1.0125em; }
      .menu a { margin-right: 0.1em; }
      #archive { margin-left: 1em; margin-top: 0; padding: 0}
      #archive .post-1, #archive .post-2 {
      margin-bottom: 0.1em;
      }
      }
      .footnote-ref { text-decoration: none; }
    </style>
  </head>
  <body>
    <div class="page-wrap">

<h1>Haskell Formlets: Composable web form construction and
validation</h1>

<p><strong>Note</strong>: This is an archive of an old 2008 post from an
old blog.</p>
<p>I think we all saw formlets some months ago when Chris Eidhof posted
a blog entry about Formlets in Haskell. For a reminder, a brief
description follows. Then I will jump straight into examples.</p>
<h2 id="description-of-a-formlet">Description of a formlet</h2>
<p>A formlet contains information about how to render itself in mark-up
language, whether values provided to it are valid, what error to show
when those values are invalid, or, if valid, the formlet returns a new
value. Perhaps as a loose model, we can enumerate these as:</p>
<ul>
<li>Presentation</li>
<li>Validation</li>
<li>Parsing</li>
<li>Failure</li>
<li>Success</li>
</ul>
<p>It is, therefore, a composition of five properties present in web
forms. I contend that keeping these properties specified in the same
place and therefore automatically consistent with eachother, is
something we want, as developers.</p>
<p>A formlet is self-contained and composable. By ‘self-contained’, this
means that all the data needed for a formlet is contained inside its
definition. By ‘composable’, this means that formlets can be used
together without influencing eachother, and that I can make new, valid,
formlets out of existing ones. Composability is something which Haskell
is exceedingly good at<a href="#fn1" class="footnote-ref" id="fnref1"
role="doc-noteref"><sup>1</sup></a>, as we will see. The Haskell
Formlets library provides us, very concisely, with a way to use
formlets. This entry discusses some examples of this library. I hope to
convince the reader that this is an excellent way to develop web
forms.</p>
<h2 id="example-1-a-user-registration-form">Example 1: A user
registration form</h2>
<p>Suppose I have a formlet that is a user registration form, called
register. The registration form takes a username and a password, and the
password must be entered twice, in two fields, for confirmation. I might
compose this formlet from two other formlets; user and pass. The user
formlet may simply display a text field, and checks that the field is
not empty. The pass formlet, on the other hand, ought to be composed of
two password entry formlets. Each of those sub-formlets will perform the
task of checking that the password is valid (such as ensuring that it is
greater than six characters in length), and the password formlet merely
needs to check that each of the values returned from these two are
equal.</p>
<p>Let us convince ourselves that we can indeed express this, using
Haskell.</p>
<p>Before defining the formlets, we’ll define a type to be returned:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Registration</span> <span class="ot">=</span> <span class="dt">Registration</span> {<span class="ot"> username ::</span> <span class="dt">String</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                                 ,<span class="ot"> password ::</span> <span class="dt">String</span> }</span></code></pre></div>
<h3 id="description-of-a-simple-validating-formlet">Description of a
simple validating formlet</h3>
<p>Firstly, for the register formlet I have added type annotations.
Types in Haskell help us understand the behaviour of our code, and here
is a good example. It is a form which displays mark-up of type Html
(provided by Text.XHtml.Strict), it is intended to be ran in some monad
m (or instance of Applicative), and returns a Registration value.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">register ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m <span class="dt">Registration</span></span></code></pre></div>
<p>Next, we can instantly see that register is composed of user and
pass.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>register <span class="ot">=</span> <span class="dt">Registration</span> <span class="op">&lt;$&gt;</span> user <span class="op">&lt;*&gt;</span> pass</span></code></pre></div>
<p>But what are user and pass? I will explain user; the meaning of pass
can then be inferred. We’ve defined user as displaying a text input box,
with no value i.e. Nothing. The value provided from this form element is
then checked against what is called a Failing<a href="#fn2"
class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>,
which ensures that a value is valid, or displays an error.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">user ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m <span class="dt">String</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>user <span class="ot">=</span> F.input <span class="dt">Nothing</span> <span class="ot">`F.check`</span> F.ensure valid <span class="fu">error</span> <span class="kw">where</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    valid <span class="ot">=</span> (<span class="op">&gt;=</span><span class="dv">3</span>)<span class="op">.</span> <span class="fu">length</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span> <span class="ot">=</span> <span class="st">&quot;Username must be three characters or longer.&quot;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="ot">pass ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m <span class="dt">String</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>pass <span class="ot">=</span> F.password <span class="dt">Nothing</span> <span class="ot">`F.check`</span> F.ensure valid <span class="fu">error</span> <span class="kw">where</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    valid <span class="ot">=</span> (<span class="op">&gt;=</span><span class="dv">6</span>)<span class="op">.</span> <span class="fu">length</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span> <span class="ot">=</span> <span class="st">&quot;Password must be six characters or longer.&quot;</span></span></code></pre></div>
<p>We can study ensure’s type briefly:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ot">ensure ::</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Failing</span> a</span></code></pre></div>
<p>It takes a validating function (e.g. valid), an error message, and a
value to validate. It either returns a Failure with the error message,
or a Success with the value.</p>
<p>Now, the type of check should make sense to us, and this is very
lovely:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ot">check ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Form</span> xml m a <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Failing</span> b) <span class="ot">-&gt;</span> <span class="dt">Form</span> xml m b</span></code></pre></div>
<p>We can see that it takes a formlet returning a, it takes a function
which validates a and returns b, finally producing a formlet which
returns b. What we have, now, is a function which wraps a validation
around a formlet, producing a new formlet.</p>
<h3 id="correction-of-the-registration-formlet">Correction of the
registration formlet</h3>
<p>Of course, the definition of pass is insufficient. It needs to
display two fields, and check them both, and ensure that their values
are equal. Let us correct this by defining a new formlet, passConfirmed.
The name means that this password has been confirmed by the user, by
their entering twice. Here is the definition<a href="#fn3"
class="footnote-ref" id="fnref3"
role="doc-noteref"><sup>3</sup></a>:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ot">passConfirmed ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m <span class="dt">String</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>passConfirmed <span class="ot">=</span> <span class="fu">fst</span> <span class="op">&lt;$&gt;</span> (passwords <span class="ot">`F.check`</span> F.ensure equal <span class="fu">error</span>) <span class="kw">where</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    passwords <span class="ot">=</span> (,) <span class="op">&lt;$&gt;</span> pass <span class="op">&lt;*&gt;</span> pass</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    equal (a,b) <span class="ot">=</span> a <span class="op">==</span> b</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span> <span class="ot">=</span> <span class="st">&quot;The entered passwords do not match!&quot;</span></span></code></pre></div>
<p>Let us study what has been written here, using types to help us:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ot">passConfirmed ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m <span class="dt">String</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>passConfirmed <span class="ot">=</span> <span class="fu">fst</span> <span class="op">&lt;$&gt;</span> validPasswords <span class="kw">where</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ot">    validPasswords ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m (<span class="dt">String</span>,<span class="dt">String</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    validPasswords <span class="ot">=</span> passwords <span class="ot">`F.check`</span> F.ensure equal <span class="fu">error</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ot">    passwords ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m (<span class="dt">String</span>,<span class="dt">String</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    passwords <span class="ot">=</span> (,) <span class="op">&lt;$&gt;</span> pass <span class="op">&lt;*&gt;</span> pass</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="ot">    equal ::</span> (<span class="dt">String</span>,<span class="dt">String</span>) <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    equal (a,b) <span class="ot">=</span> a <span class="op">==</span> b</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span> <span class="ot">=</span> <span class="st">&quot;The entered passwords do not match!&quot;</span></span></code></pre></div>
<p>The validPasswords is what could be described as a wrapper around
passwords, which validates the values, and simply returns them if valid
(i.e. equal). passwords simply takes two valid passwords, and puts them
in a tuple.</p>
<p>Here we must recognise something special! Composability, ladies and
gentlemen! Our passConfirmed formlet does not have to care about whether
the passwords are six characters or longer, because the pass formlets
have done this for us!</p>
<p>We can now go back to our register formlet and update the code:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ot">register ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m <span class="dt">Registration</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>register <span class="ot">=</span> <span class="dt">Registration</span> <span class="op">&lt;$&gt;</span> user <span class="op">&lt;*&gt;</span> passConfirmed</span></code></pre></div>
<h3 id="adding-labels-wrapping-mark-up">Adding labels: wrapping
mark-up</h3>
<p>Right now, despite being very lovely, the display of our widgets
would be less than presentable. There are no labels on the form inputs!
Neither the user nor the pass are labelled. They are also not
paragraphed, in the mark-up. Therefore let us write a function which
will take a formlet and stick a label and a paragraph around it.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>label l <span class="ot">=</span> F.plug (\xhtml <span class="ot">-&gt;</span> X.p <span class="op">&lt;&lt;</span> (X.label <span class="op">&lt;&lt;</span> (l <span class="op">++</span> <span class="st">&quot;: &quot;</span>) <span class="op">+++</span> xhtml))</span></code></pre></div>
<p>What does the plug function do? Let us study its type:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ot">plug ::</span> (<span class="dt">Monad</span> m, <span class="dt">Plus</span> xml) <span class="ot">=&gt;</span> (xml <span class="ot">-&gt;</span> xml1) <span class="ot">-&gt;</span> <span class="dt">Form</span> xml m a <span class="ot">-&gt;</span> <span class="dt">Form</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>xml1 m a</span></code></pre></div>
<p>It’s quite simple, of course. It takes a function which transforms
some mark-up, a form, and returns a new form with the changed
mark-up.</p>
<p>Therefore our label function simply wraps some XHTML around the
existing formlet. Now, we can use it.</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ot">user ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m <span class="dt">String</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>user <span class="ot">=</span> input <span class="ot">`F.check`</span> F.ensure valid <span class="fu">error</span> <span class="kw">where</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    input <span class="ot">=</span> <span class="st">&quot;Username&quot;</span> <span class="ot">`label`</span> F.input <span class="dt">Nothing</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    valid <span class="ot">=</span> (<span class="op">&gt;=</span><span class="dv">3</span>)<span class="op">.</span> <span class="fu">length</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span> <span class="ot">=</span> <span class="st">&quot;Username must be three characters or longer.&quot;</span></span></code></pre></div>
<p>We now have a proper label for the user input field. We ought to now
confirm that this is indeed the case by running our code. …Finally!</p>
<h3 id="running-a-formlet">Running a Formlet</h3>
<p>In order to run our formlet, we need to use the runFormState
function. Studying its type, we see that it takes an environment, a
prefix for the form’s element names, and the formlet itself. Finally, it
returns a tuple of the return success or failure of the form, mark-up
which ought to be displayed, and the form content type, which we are not
interested in.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ot">runFormState ::</span> <span class="dt">Monad</span> m</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>             <span class="ot">=&gt;</span> <span class="dt">Env</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>             <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>             <span class="ot">-&gt;</span> <span class="dt">Form</span> xml m a</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>             <span class="ot">-&gt;</span> (m (<span class="dt">Failing</span> a),m xml,<span class="dt">FormContentType</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Env</span> <span class="ot">=</span> [(<span class="dt">String</span>, <span class="dt">Either</span> <span class="dt">String</span> <span class="dt">File</span>)]</span></code></pre></div>
<p>We are interested only in the String form of values in the
environment.</p>
<p>Let us confirm that our code outputs what has been described:</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="op">:</span>load <span class="st">&quot;/var/www/chrisdone/blog/db/static/Register.hs&quot;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span> <span class="kw">of</span> <span class="dv">1</span>] <span class="dt">Compiling</span> <span class="dt">Register</span> ( Register.hs, interpreted )</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Ok</span>, modules loaded<span class="op">:</span> <span class="dt">Register</span><span class="op">.</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> env <span class="ot">=</span> <span class="fu">map</span> ((<span class="st">&quot;input&quot;</span><span class="op">++</span>) <span class="op">.</span> <span class="fu">show</span>) [<span class="dv">0</span><span class="op">..</span>] <span class="ot">`zip`</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">map</span> <span class="dt">Left</span> [<span class="st">&quot;chris&quot;</span>,<span class="st">&quot;mypassword&quot;</span>,<span class="st">&quot;mypassword&quot;</span>]</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> (result,xml,_) <span class="ot">=</span> runFormState env <span class="st">&quot;&quot;</span> register</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="fu">putStrLn</span> <span class="op">.</span> X.prettyHtmlFragment <span class="op">=&lt;&lt;</span> xml</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>p<span class="op">&gt;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>   <span class="op">&lt;</span>label<span class="op">&gt;</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Username</span><span class="op">:</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>   <span class="op">&lt;/</span>label<span class="op">&gt;</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>   <span class="op">&lt;</span>input <span class="kw">type</span><span class="ot">=</span><span class="st">&quot;text&quot;</span> name<span class="ot">=</span><span class="st">&quot;input0&quot;</span> <span class="fu">id</span><span class="ot">=</span><span class="st">&quot;input0&quot;</span> value<span class="ot">=</span><span class="st">&quot;chris&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>p<span class="op">&gt;</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>input <span class="kw">type</span><span class="ot">=</span><span class="st">&quot;password&quot;</span> name<span class="ot">=</span><span class="st">&quot;input1&quot;</span> <span class="fu">id</span><span class="ot">=</span><span class="st">&quot;input1&quot;</span> value<span class="ot">=</span><span class="st">&quot;mypassword&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>input <span class="kw">type</span><span class="ot">=</span><span class="st">&quot;password&quot;</span> name<span class="ot">=</span><span class="st">&quot;input2&quot;</span> <span class="fu">id</span><span class="ot">=</span><span class="st">&quot;input2&quot;</span> value<span class="ot">=</span><span class="st">&quot;mypassword&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span></span></code></pre></div>
<p>Here we have provided runFormState with a basic environment;
providing a value for the username and passwords. The result
demonstrates that our label wrapper does indeed work as described.</p>
<p>Finally, we can add labels to our password inputs:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ot">passConfirmed ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m <span class="dt">String</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>passConfirmed <span class="ot">=</span> <span class="fu">fst</span> <span class="op">&lt;$&gt;</span> passwords <span class="ot">`F.check`</span> F.ensure equal <span class="fu">error</span> <span class="kw">where</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    passwords <span class="ot">=</span> (,) <span class="op">&lt;$&gt;</span> pass <span class="st">&quot;Password&quot;</span> <span class="op">&lt;*&gt;</span> pass <span class="st">&quot;Password (confirm)&quot;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    equal (a,b) <span class="ot">=</span> a <span class="op">==</span> b</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span> <span class="ot">=</span> <span class="st">&quot;The entered passwords do not match!&quot;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="ot">pass ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m <span class="dt">String</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>pass caption <span class="ot">=</span> input <span class="ot">`F.check`</span> F.ensure valid <span class="fu">error</span> <span class="kw">where</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    input <span class="ot">=</span> caption <span class="ot">`label`</span> F.password <span class="dt">Nothing</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    valid <span class="ot">=</span> (<span class="op">&gt;=</span><span class="dv">6</span>)<span class="op">.</span> <span class="fu">length</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span> <span class="ot">=</span> <span class="st">&quot;Password must be six characters or longer.&quot;</span></span></code></pre></div>
<p>We have simply added an extra argument to our pass formlet which
takes an argument for what label to display next to it. Thus we have the
following output:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="dt">Prelude</span><span class="op">&gt;</span> <span class="op">:</span>load <span class="st">&quot;/var/www/chrisdone/blog/db/static/Register.hs&quot;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span> <span class="kw">of</span> <span class="dv">1</span>] <span class="dt">Compiling</span> <span class="dt">Register</span> ( Register.hs, interpreted )</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Ok</span>, modules loaded<span class="op">:</span> <span class="dt">Register</span><span class="op">.</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> env <span class="ot">=</span> <span class="fu">map</span> ((<span class="st">&quot;input&quot;</span><span class="op">++</span>) <span class="op">.</span> <span class="fu">show</span>) [<span class="dv">0</span><span class="op">..</span>] <span class="ot">`zip`</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">map</span> <span class="dt">Left</span> [<span class="st">&quot;chris&quot;</span>,<span class="st">&quot;mypassword&quot;</span>,<span class="st">&quot;mypassword&quot;</span>]</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> (result,xml,_) <span class="ot">=</span> runFormState env <span class="st">&quot;&quot;</span> register</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="fu">putStrLn</span> <span class="op">.</span> X.prettyHtmlFragment <span class="op">=&lt;&lt;</span> xml</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>p<span class="op">&gt;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>   <span class="op">&lt;</span>label<span class="op">&gt;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Username</span><span class="op">:</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>   <span class="op">&lt;/</span>label<span class="op">&gt;</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>   <span class="op">&lt;</span>input <span class="kw">type</span><span class="ot">=</span><span class="st">&quot;text&quot;</span> name<span class="ot">=</span><span class="st">&quot;input0&quot;</span> <span class="fu">id</span><span class="ot">=</span><span class="st">&quot;input0&quot;</span> value<span class="ot">=</span><span class="st">&quot;chris&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>p<span class="op">&gt;</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>p<span class="op">&gt;</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>   <span class="op">&lt;</span>label<span class="op">&gt;</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Password</span><span class="op">:</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>   <span class="op">&lt;/</span>label<span class="op">&gt;</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>   <span class="op">&lt;</span>input <span class="kw">type</span><span class="ot">=</span><span class="st">&quot;password&quot;</span> name<span class="ot">=</span><span class="st">&quot;input1&quot;</span> <span class="fu">id</span><span class="ot">=</span><span class="st">&quot;input1&quot;</span> value<span class="ot">=</span><span class="st">&quot;mypassword&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>p<span class="op">&gt;</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>p<span class="op">&gt;</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>   <span class="op">&lt;</span>label<span class="op">&gt;</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Password</span> (confirm)<span class="op">:</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>   <span class="op">&lt;/</span>label<span class="op">&gt;</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>   <span class="op">&lt;</span>input <span class="kw">type</span><span class="ot">=</span><span class="st">&quot;password&quot;</span> name<span class="ot">=</span><span class="st">&quot;input2&quot;</span> <span class="fu">id</span><span class="ot">=</span><span class="st">&quot;input2&quot;</span> value<span class="ot">=</span><span class="st">&quot;mypassword&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>p<span class="op">&gt;</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> env <span class="ot">=</span> <span class="fu">map</span> ((<span class="st">&quot;input&quot;</span><span class="op">++</span>) <span class="op">.</span> <span class="fu">show</span>) [<span class="dv">0</span><span class="op">..</span>] <span class="ot">`zip`</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">map</span> <span class="dt">Left</span> [<span class="st">&quot;chris&quot;</span>,<span class="st">&quot;mypassword&quot;</span>,<span class="st">&quot;mypa&quot;</span>]</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> (result,xml,_) <span class="ot">=</span> runFormState env <span class="st">&quot;&quot;</span> register <span class="kw">in</span> result</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="dt">Failure</span> [<span class="st">&quot;Password must be six characters or longer.&quot;</span>]</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> env <span class="ot">=</span> <span class="fu">map</span> ((<span class="st">&quot;input&quot;</span><span class="op">++</span>) <span class="op">.</span> <span class="fu">show</span>) [<span class="dv">0</span><span class="op">..</span>] <span class="ot">`zip`</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">map</span> <span class="dt">Left</span> [<span class="st">&quot;chris&quot;</span>,<span class="st">&quot;mypassword&quot;</span>,<span class="st">&quot;mypassword-&quot;</span>]</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> (result,xml,_) <span class="ot">=</span> runFormState env <span class="st">&quot;&quot;</span> register <span class="kw">in</span> result</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="dt">Failure</span> [<span class="st">&quot;The entered passwords do not match!&quot;</span>]</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> env <span class="ot">=</span> <span class="fu">map</span> ((<span class="st">&quot;input&quot;</span><span class="op">++</span>) <span class="op">.</span> <span class="fu">show</span>) [<span class="dv">0</span><span class="op">..</span>] <span class="ot">`zip`</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">map</span> <span class="dt">Left</span> [<span class="st">&quot;chris&quot;</span>,<span class="st">&quot;mypassword&quot;</span>,<span class="st">&quot;mypassword&quot;</span>]</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> (result,xml,_) <span class="ot">=</span> runFormState env <span class="st">&quot;&quot;</span> register <span class="kw">in</span> result</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="dt">Success</span> (<span class="dt">Registration</span> {regUser <span class="ot">=</span> <span class="st">&quot;chris&quot;</span>, regPass <span class="ot">=</span> <span class="st">&quot;mypassword&quot;</span>})</span></code></pre></div>
<p>We now have a full, presentable, composable, validating formlet.</p>
<h3 id="complete-haskell-source">Complete Haskell source</h3>
<p>Below is the source code in full for the reader to read, test and/or
run:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Register</span> <span class="kw">where</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Applicative</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.CGI</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.Formlets</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.XHtml.Strict.Formlets</span> (<span class="dt">Form</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.XHtml.Strict.Formlets</span> <span class="kw">as</span> <span class="dt">F</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.XHtml.Strict</span> <span class="kw">as</span> <span class="dt">X</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.XHtml.Strict</span> ((&lt;&lt;),(+++))</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Registration</span> <span class="ot">=</span> <span class="dt">Registration</span> {<span class="ot"> regUser ::</span> <span class="dt">String</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>                                 ,<span class="ot"> regPass ::</span> <span class="dt">String</span> }</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>                                 <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="ot">register ::</span> <span class="dt">Form</span> <span class="dt">Html</span> <span class="dt">IO</span> <span class="dt">Registration</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>register <span class="ot">=</span> <span class="dt">Registration</span> <span class="op">&lt;$&gt;</span> user <span class="op">&lt;*&gt;</span> passConfirmed</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="ot">user ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m <span class="dt">String</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>user <span class="ot">=</span> input <span class="ot">`F.check`</span> F.ensure valid <span class="fu">error</span> <span class="kw">where</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    input <span class="ot">=</span> <span class="st">&quot;Username&quot;</span> <span class="ot">`label`</span> F.input <span class="dt">Nothing</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    valid <span class="ot">=</span> (<span class="op">&gt;=</span><span class="dv">3</span>)<span class="op">.</span> <span class="fu">length</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span> <span class="ot">=</span> <span class="st">&quot;Username must be three characters or longer.&quot;</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="ot">passConfirmed ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m <span class="dt">String</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>passConfirmed <span class="ot">=</span> <span class="fu">fst</span> <span class="op">&lt;$&gt;</span> passwords <span class="ot">`F.check`</span> F.ensure equal <span class="fu">error</span> <span class="kw">where</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    passwords <span class="ot">=</span> (,) <span class="op">&lt;$&gt;</span> pass <span class="st">&quot;Password&quot;</span> <span class="op">&lt;*&gt;</span> pass <span class="st">&quot;Password (confirm)&quot;</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    equal (a,b) <span class="ot">=</span> a <span class="op">==</span> b</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span> <span class="ot">=</span> <span class="st">&quot;The entered passwords do not match!&quot;</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="ot">pass ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m <span class="dt">String</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>pass caption <span class="ot">=</span> input <span class="ot">`F.check`</span> F.ensure valid <span class="fu">error</span> <span class="kw">where</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    input <span class="ot">=</span> caption <span class="ot">`label`</span> F.password <span class="dt">Nothing</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    valid <span class="ot">=</span> (<span class="op">&gt;=</span><span class="dv">6</span>)<span class="op">.</span> <span class="fu">length</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span> <span class="ot">=</span> <span class="st">&quot;Password must be six characters or longer.&quot;</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="ot">label ::</span> (<span class="dt">X.HTML</span> xml,<span class="dt">Monad</span> m,<span class="dt">Plus</span> xml)</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>      <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Form</span> xml m a <span class="ot">-&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m a</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>label l <span class="ot">=</span> F.plug (\xhtml <span class="ot">-&gt;</span> X.p <span class="op">&lt;&lt;</span> (X.label <span class="op">&lt;&lt;</span> (l <span class="op">++</span> <span class="st">&quot;: &quot;</span>) <span class="op">+++</span> xhtml))</span></code></pre></div>
<p>Keen eyes will notice that I have changed the type of register:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ot">register ::</span> <span class="dt">Form</span> <span class="dt">Html</span> <span class="dt">IO</span> <span class="dt">Registration</span></span></code></pre></div>
<p>I have set the monad type to IO. This is merely because we are
testing it in GHCi, which defaults to the IO monad, which is just dandy
for our purposes.<a href="#fn4" class="footnote-ref" id="fnref4"
role="doc-noteref"><sup>4</sup></a></p>
<h2 id="example-2-user-registration-with-monadic-validation">Example 2:
User registration with monadic validation</h2>
<p>We have so far covered how to develop a formlet from an informal
description, improve it and then test it in our Haskell prompt. We have
addressed the four points previously mentioned, i.e. we have worked with
how formlets are presented in mark-up, we have worked with how they
validate input, how they fail on invalid input, and how they succeed on
valid input. Furthermore, we have demonstrated to ourselves, albiet in a
limited way, that all of these things can be composed.</p>
<p>So far, our validation has been pure. A formlet takes a value and
validates it purely functionally. This is completely acceptable. Indeed,
initially the Haskell Formlets library was only pure. However, we now
have access to monadic validation! Yes! We shall briefly discuss why
this is a good, and then demonstrate with an example.</p>
<p>Consider a customer database; we want to use this database in our
registration form. Suppose we want to check to see if the username
already exists in the database. If it does, the form fails, otherwise it
returns a registration which can then be sent off to some other function
we don’t care about right now. This means that when validation occurs,
it ought to have the ability to behave differently for the same input.
We need to impurely talk to the database in order to complete the
validation. But why do the formlets need to be impure? Why not run the
whole form, and then compare the returned values against a database?
Because then the whole model of composability is broken. It is no longer
a formlet that validates inputs. It is a formlet that validates some
inputs, and then breaks the abstraction when it gets a bit hairy. We
want to be able to have a username formlet that has everything necessary
in its description contained within its definition. We are now going to
experiment with this notion.</p>
<p>Let us continue from where we left off from Example 1.</p>
<h3 id="create-a-simple-database-to-use">Create a simple database to
use</h3>
<p>For this example, we’ll play it safe and use Sqlite3.</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Database.HDBC</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Database.HDBC.Sqlite3</span></span></code></pre></div>
<p>We shall create a customer table with some entries to work with, with
md5 hashed passwords:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="dt">Prelude</span><span class="op">&gt;</span> <span class="op">:</span>set prompt <span class="st">&quot;Haskell&gt; &quot;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Haskell</span><span class="op">&gt;</span> <span class="op">:</span>set <span class="op">-</span><span class="dt">XOverloadedStrings</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Haskell</span><span class="op">&gt;</span> <span class="op">:</span>m <span class="op">+</span> <span class="dt">Data.Digest.Pure.MD5</span> <span class="dt">Data.ByteString.Lazy.Char8</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="dt">Haskell</span><span class="op">&gt;</span> md5 <span class="st">&quot;haskell4life&quot;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="dt">Loading</span> package syb <span class="op">...</span> linking <span class="op">...</span> done<span class="op">.</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="dt">Loading</span> package base<span class="op">-</span><span class="fl">3.0</span><span class="op">.</span><span class="fl">3.0</span> <span class="op">...</span> linking <span class="op">...</span> done<span class="op">.</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="dt">Loading</span> package array<span class="op">-</span><span class="fl">0.2</span><span class="op">.</span><span class="fl">0.0</span> <span class="op">...</span> linking <span class="op">...</span> done<span class="op">.</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="dt">Loading</span> package containers<span class="op">-</span><span class="fl">0.2</span><span class="op">.</span><span class="fl">0.0</span> <span class="op">...</span> linking <span class="op">...</span> done<span class="op">.</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="dt">Loading</span> package bytestring<span class="op">-</span><span class="fl">0.9</span><span class="op">.</span><span class="fl">1.4</span> <span class="op">...</span> linking <span class="op">...</span> done<span class="op">.</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="dt">Loading</span> package binary<span class="op">-</span><span class="fl">0.4</span><span class="op">.</span><span class="dv">4</span> <span class="op">...</span> linking <span class="op">...</span> done<span class="op">.</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="dt">Loading</span> package pureMD5<span class="op">-</span><span class="fl">0.2</span><span class="op">.</span><span class="dv">4</span> <span class="op">...</span> linking <span class="op">...</span> done<span class="op">.</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="dv">8</span>afba4d177e7162510b9edf0139d1e8c</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="dt">Haskell</span><span class="op">&gt;</span> md5 <span class="st">&quot;expert programmer&quot;</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>c60ce6776f224600bb33e463aa68d138</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="dt">Haskell</span><span class="op">&gt;</span></span></code></pre></div>
<p>The OverloadedStrings option lets us write string literals which can
be provided as String or ByteString.<a href="#fn5" class="footnote-ref"
id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>chris<span class="op">@</span>chrisdesktop<span class="op">:/</span>var<span class="op">/</span>www<span class="op">/</span>chrisdone<span class="op">/</span>blog<span class="op">/</span>db<span class="op">/</span>static<span class="op">$</span> sqlite3 <span class="co">--version</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fl">3.4</span><span class="op">.</span><span class="dv">2</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>chris<span class="op">@</span>chrisdesktop<span class="op">:/</span>var<span class="op">/</span>www<span class="op">/</span>chrisdone<span class="op">/</span>blog<span class="op">/</span>db<span class="op">/</span>static<span class="op">$</span> sqlite3 customer<span class="op">.</span>db</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="dt">SQLite</span> version <span class="fl">3.4</span><span class="op">.</span><span class="dv">2</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="dt">Enter</span> <span class="st">&quot;.help&quot;</span> for instructions</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>sqlite<span class="op">&gt;</span> <span class="dt">CREATE</span> <span class="dt">TABLE</span> <span class="ot">`customer`</span> (<span class="ot">`id`</span> <span class="dt">INTEGER</span> <span class="dt">PRIMARY_KEY</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="dt">AUTO_INCREMENT</span>, <span class="ot">`username`</span> <span class="dt">TINY</span> <span class="dt">BLOB</span>, <span class="ot">`password`</span> <span class="dt">BLOB</span>);</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>sqlite<span class="op">&gt;</span> <span class="dt">INSERT</span> <span class="dt">INTO</span> <span class="ot">`customer`</span> (<span class="ot">`username`</span>, <span class="ot">`password`</span>) <span class="dt">VALUES</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>(<span class="dt">&#39;Peyton</span> <span class="ot">`Simon`</span> <span class="dt">Jones&#39;</span>, &#39;<span class="dv">085</span>b1b14b7212a61ab8bffe89b02c254&#39;);</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>sqlite<span class="op">&gt;</span> <span class="dt">INSERT</span> <span class="dt">INTO</span> <span class="ot">`customer`</span> (<span class="ot">`username`</span>, <span class="ot">`password`</span>) <span class="dt">VALUES</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>(<span class="dt">&#39;Christopher</span> <span class="dt">Done&#39;</span>, &#39;c60ce6776f224600bb33e463aa68d138&#39;);</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>sqlite<span class="op">&gt;</span> <span class="dt">SELECT</span> <span class="op">*</span> <span class="dt">FROM</span> <span class="ot">`customer`</span>;</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="op">|</span><span class="dt">Christopher</span> <span class="dt">Done</span><span class="op">|</span>c60ce6776f224600bb33e463aa68d138</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="op">|</span><span class="dt">Peyton</span> <span class="ot">`Simon`</span> <span class="dt">Jones</span><span class="op">|</span><span class="dv">085</span>b1b14b7212a61ab8bffe89b02c254</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>sqlite<span class="op">&gt;</span> <span class="op">.</span>quit</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>chris<span class="op">@</span>chrisdesktop<span class="op">:/</span>var<span class="op">/</span>www<span class="op">/</span>chrisdone<span class="op">/</span>blog<span class="op">/</span>db<span class="op">/</span>static<span class="op">$</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="dt">And</span> now ensuring we have access from <span class="dt">Haskell&#39;s</span> library<span class="op">:</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="dt">Haskell</span><span class="op">&gt;</span> <span class="op">:</span>load <span class="st">&quot;/var/www/chrisdone/blog/db/static/Register.hs&quot;</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span> <span class="kw">of</span> <span class="dv">1</span>] <span class="dt">Compiling</span> <span class="dt">Register</span> ( Register.hs, interpreted )</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="dt">Ok</span>, modules loaded<span class="op">:</span> <span class="dt">Register</span><span class="op">.</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="dt">Haskell</span><span class="op">&gt;</span> con <span class="ot">&lt;-</span> connectSqlite3 <span class="st">&quot;customer.db&quot;</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="dt">Haskell</span><span class="op">&gt;</span> getTables con</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>[<span class="st">&quot;customer&quot;</span>]</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="dt">Haskell</span><span class="op">&gt;</span> quickQuery con <span class="st">&quot;SELECT * FROM `customer`&quot;</span> []</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>[[<span class="dt">SqlNull</span>,<span class="dt">SqlString</span> <span class="st">&quot;Christopher Done&quot;</span>,</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">SqlString</span> <span class="st">&quot;c60ce6776f224600bb33e463aa68d138&quot;</span>],</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>[<span class="dt">SqlNull</span>,<span class="dt">SqlString</span> <span class="st">&quot;Peyton `Simon` Jones&quot;</span>,</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a> <span class="dt">SqlString</span> <span class="st">&quot;085b1b14b7212a61ab8bffe89b02c254&quot;</span>]]</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="dt">Haskell</span><span class="op">&gt;</span> quickQuery con <span class="st">&quot;SELECT * FROM `customer`</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE `username` LIKE &#39;Christopher Done&#39;;&quot;</span> []</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>[[<span class="dt">SqlNull</span>,<span class="dt">SqlString</span> <span class="st">&quot;Christopher Done&quot;</span>,</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">SqlString</span> <span class="st">&quot;c60ce6776f224600bb33e463aa68d138&quot;</span>]]</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="dt">Haskell</span><span class="op">&gt;</span></span></code></pre></div>
<h3 id="validating-against-an-sql-database">Validating against an SQL
database</h3>
<p>Let us now return to studying how to impurely validate in a formlet.
We notice that the types thus far have all talked about a monad type,
which we have ignored so far. Now we can make use of it:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ot">checkM ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Form</span> xml m a <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> m (<span class="dt">Failing</span> b)) <span class="ot">-&gt;</span> <span class="dt">Form</span> xml m b</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ot">ensureM ::</span> (<span class="dt">Monad</span> m, <span class="dt">Show</span> a) <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> m <span class="dt">Bool</span>) <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> m (<span class="dt">Failing</span> a)</span></code></pre></div>
<p>These functions are monadic equivalents of check and ensure.
Therefore, with this in mind, let us consider our definition of
user.</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ot">user ::</span> (<span class="dt">Applicative</span> m,<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> m <span class="dt">String</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>user <span class="ot">=</span> input <span class="ot">`F.check`</span> F.ensure valid <span class="fu">error</span> <span class="kw">where</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    input <span class="ot">=</span> <span class="st">&quot;Username&quot;</span> <span class="ot">`label`</span> F.input <span class="dt">Nothing</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    valid <span class="ot">=</span> (<span class="op">&gt;=</span><span class="dv">3</span>)<span class="op">.</span> <span class="fu">length</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span> <span class="ot">=</span> <span class="st">&quot;Username must be three characters or longer.&quot;</span></span></code></pre></div>
<p>I think that this formlet is a fine piece of code. Indeed, we do not
need to change it at all. Instead, let us define a new formlet which
wraps around this one, called uniqueUser:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ot">uniqueUser ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">Form</span> <span class="dt">Html</span> <span class="dt">IO</span> <span class="dt">String</span></span></code></pre></div>
<p>In order to query against the database we will need to pass the
connection handle along. Or will we? I propose a ReaderT monad!</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad.Reader</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">SQLM</span> <span class="ot">=</span> <span class="dt">ReaderT</span> <span class="dt">Connection</span> <span class="dt">IO</span></span></code></pre></div>
<p>Our computation also needs to be an instance of Applicative to work
with Formlets, so we define an instance for all ReaderT types:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Applicative</span> (<span class="dt">ReaderT</span> s m) <span class="kw">where</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> <span class="ot">=</span> <span class="fu">return</span>; (<span class="op">&lt;*&gt;</span>) <span class="ot">=</span> ap</span></code></pre></div>
<p>We’ll define a simple utility function which will take the connection
from the monad and use it for a query:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ot">query ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [<span class="dt">SqlValue</span>] <span class="ot">-&gt;</span> <span class="dt">SQLM</span> [[<span class="dt">SqlValue</span>]]</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>query statement values <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  conn <span class="ot">&lt;-</span> ask</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> quickQuery conn statement values</span></code></pre></div>
<p>A demonstration might be something like:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> runReaderT (query <span class="st">&quot;SELECT * FROM `customer`&quot;</span> []) con</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>[[<span class="dt">SqlNull</span>,<span class="dt">SqlString</span> <span class="st">&quot;Christopher Done&quot;</span>,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">SqlString</span> <span class="st">&quot;c60ce6776f224600bb33e463aa68d138&quot;</span>],</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a> [<span class="dt">SqlNull</span>,<span class="dt">SqlString</span> <span class="st">&quot;Peyton `Simon` Jones&quot;</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a> <span class="dt">SqlString</span> <span class="st">&quot;085b1b14b7212a61ab8bffe89b02c254&quot;</span>]]</span></code></pre></div>
<p>Therefore we can make a very neat definition of uniqueUser:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ot">uniqueUser ::</span> <span class="dt">Form</span> <span class="dt">Html</span> <span class="dt">SQLM</span> <span class="dt">String</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>uniqueUser <span class="ot">=</span> user <span class="ot">`F.checkM`</span> F.ensureM valid <span class="fu">error</span> <span class="kw">where</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>valid name <span class="ot">=</span> <span class="fu">null</span> <span class="op">&lt;$&gt;</span> query statement [toSql name]</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>statement <span class="ot">=</span> <span class="st">&quot;SELECT * FROM `customer` WHERE `username` LIKE ?&quot;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">error</span> <span class="ot">=</span> <span class="st">&quot;Username already exists in the database!&quot;</span></span></code></pre></div>
<p>I warn the reader of potential heart failure, excretions or other
effects due to viewing the next section. Let us now test our monadic
validating formlet:</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="op">:</span>load <span class="st">&quot;/var/www/chrisdone/blog/db/static/Register.hs&quot;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span> <span class="kw">of</span> <span class="dv">1</span>] <span class="dt">Compiling</span> <span class="dt">Register</span> ( Register.hs, interpreted )</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Ok</span>, modules loaded<span class="op">:</span> <span class="dt">Register</span><span class="op">.</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> env <span class="ot">=</span> <span class="fu">map</span> ((<span class="st">&quot;input&quot;</span><span class="op">++</span>) <span class="op">.</span> <span class="fu">show</span>) [<span class="dv">0</span><span class="op">..</span>] <span class="ot">`zip`</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">map</span> <span class="dt">Left</span> [<span class="st">&quot;chris&quot;</span>,<span class="st">&quot;mypassword&quot;</span>,<span class="st">&quot;mypassword&quot;</span>]</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> con <span class="ot">&lt;-</span> connectSqlite3 <span class="st">&quot;customer.db&quot;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> (result,xml,_) <span class="ot">=</span> runFormState env <span class="st">&quot;&quot;</span> register</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>           <span class="kw">in</span> runReaderT result con</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="dt">Success</span> (<span class="dt">Registration</span> {regUser <span class="ot">=</span> <span class="st">&quot;chris&quot;</span>, regPass <span class="ot">=</span> <span class="st">&quot;mypassword&quot;</span>})</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> env <span class="ot">=</span> <span class="fu">map</span> ((<span class="st">&quot;input&quot;</span><span class="op">++</span>) <span class="op">.</span> <span class="fu">show</span>) [<span class="dv">0</span><span class="op">..</span>] <span class="ot">`zip`</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">map</span> <span class="dt">Left</span> [<span class="st">&quot;christopher done&quot;</span>,<span class="st">&quot;mypassword&quot;</span>,<span class="st">&quot;mypassword&quot;</span>]</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> (result,xml,_) <span class="ot">=</span> runFormState env <span class="st">&quot;&quot;</span> register</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>           <span class="kw">in</span> runReaderT result con</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="dt">Failure</span> [<span class="st">&quot;Username already exists in the database!&quot;</span>]</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span></span></code></pre></div>
<p>I shall summarise what has been covered in this section. We have
familiarised ourselves with monadic version of check and ensure. We have
happily combined pure and impure formlets, and kept each formlet
contained, doing one thing well. ’Tis the beauty of abstraction in
programming at its most clear. We have established how to run a formlet
with a monad such as ReaderT, and we can see how this might be done with
StateT, for instance.</p>
<h2 id="example-3-custom-form-inputs">Example 3: Custom form inputs</h2>
<p>Earlier, we touched upon producing custom mark-up for a formlet, by
wrapping around an existing one. We will now create our own (simple)
form input from scratch; that which is not provided in the
Text.XHtml.Formlets library; a checkbox.</p>
<p>A checkbox can only return two values, checked or unchecked,
therefore Bool is completely satisfactory as a return value for our
formlet. To help us think about the type, let’s look at an existing form
input’s type:</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ot">radio ::</span> <span class="dt">Monad</span> m</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>      <span class="ot">=&gt;</span> [(<span class="dt">String</span>,<span class="dt">String</span>)] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">XHtmlForm</span> m <span class="dt">String</span></span></code></pre></div>
<p>It takes a list of (name,value) pairs, a default value, and returns a
choice of radio buttons.</p>
<p>It is worth noting that the type XHtmlForm is simply an alias for
specifying the Text.XHtml.Strict.html type, defined as type XHtmlForm m
a = Form Html m a.</p>
<p>Our type should be as follows:</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ot">checkbox ::</span> <span class="dt">Monad</span> m</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>         <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">XHtmlForm</span> m <span class="dt">String</span></span></code></pre></div>
<p>Take, a caption for the checkbox, maybe a default value, and return a
checkbox which returns “yes” or “no”.</p>
<p>To implement a form input, we need the input’ function:</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ot">input&#39; ::</span> <span class="dt">Monad</span> m</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>       <span class="ot">=&gt;</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> xml) <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Form</span> xml m <span class="dt">String</span></span></code></pre></div>
<p>input’ takes a function that takes a name for the element in markup,
and a value, input’ also takes maybe default value for the element, and
finally returns a formlet.</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ot">checkbox ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">XHtmlForm</span> m <span class="dt">String</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>checkbox caption def <span class="ot">=</span> input&#39; box def <span class="kw">where</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    box name value <span class="ot">=</span> X.input <span class="op">!</span> ([X.thetype <span class="st">&quot;checkbox&quot;</span>, X.name name] <span class="op">++</span> checked)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                     <span class="op">+++</span> caption</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">where</span> checked <span class="op">|</span> value <span class="op">==</span> <span class="st">&quot;yes&quot;</span> <span class="op">||</span> value <span class="op">==</span> <span class="st">&quot;on&quot;</span> <span class="ot">=</span> [X.checked]</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                      <span class="op">|</span> <span class="fu">otherwise</span>  <span class="ot">=</span> []</span></code></pre></div>
<p>It is quite simple. There is nothing fancy to be done. Merely produce
the correct markup. We can test it in GHCi to confirm:</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> env <span class="ot">=</span> <span class="fu">map</span> ((<span class="st">&quot;input&quot;</span><span class="op">++</span>) <span class="op">.</span> <span class="fu">show</span>) [<span class="dv">0</span><span class="op">..</span>] <span class="ot">`zip`</span> <span class="fu">map</span> <span class="dt">Left</span> [<span class="st">&quot;yes&quot;</span>]</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> (result,xml,_) <span class="ot">=</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>             runFormState env <span class="st">&quot;&quot;</span> (checkbox <span class="st">&quot;Send me spam?&quot;</span> <span class="dt">Nothing</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>           <span class="kw">in</span> <span class="kw">do</span> r <span class="ot">&lt;-</span> result; x <span class="ot">&lt;-</span> xml; <span class="fu">return</span> (r,x)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>(<span class="dt">Success</span> <span class="st">&quot;yes&quot;</span>,<span class="op">&lt;</span>input <span class="kw">type</span><span class="ot">=</span><span class="st">&quot;checkbox&quot;</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>name<span class="ot">=</span><span class="st">&quot;input0&quot;</span> checked<span class="ot">=</span><span class="st">&quot;checked&quot;</span> <span class="op">/&gt;</span><span class="dt">Send</span> me spam<span class="op">?</span>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> env <span class="ot">=</span> <span class="fu">map</span> ((<span class="st">&quot;input&quot;</span><span class="op">++</span>) <span class="op">.</span> <span class="fu">show</span>) [<span class="dv">0</span><span class="op">..</span>] <span class="ot">`zip`</span> <span class="fu">map</span> <span class="dt">Left</span> [<span class="st">&quot;no&quot;</span>]</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span> <span class="kw">let</span> (result,xml,_) <span class="ot">=</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>             runFormState env <span class="st">&quot;&quot;</span> (checkbox <span class="st">&quot;Send me spam?&quot;</span> <span class="dt">Nothing</span>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>           <span class="kw">in</span> <span class="kw">do</span> r <span class="ot">&lt;-</span> result; x <span class="ot">&lt;-</span> xml; <span class="fu">return</span> (r,x)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>(<span class="dt">Success</span> <span class="st">&quot;no&quot;</span>,<span class="op">&lt;</span>input <span class="kw">type</span><span class="ot">=</span><span class="st">&quot;checkbox&quot;</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>name<span class="ot">=</span><span class="st">&quot;input0&quot;</span><span class="op">/&gt;</span><span class="dt">Send</span> me spam<span class="op">?</span>)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="op">*</span><span class="dt">Register</span><span class="op">&gt;</span></span></code></pre></div>
<p>Of course, we have only demonstrated a very simple example. However,
most form elements are simple. The point here is that one can use
arbitary markup in a formlet and then compose that with any other.
Consider a clever Javascript colour selector, and such things like
that.</p>
<h2 id="formlets-in-a-real-cgi-program">Formlets in a real CGI
program</h2>
<p>We have now covered the lovely features of the Haskell Formlets.
Finally, I have put our demonstration code into practise in a live
server application which simply accepts registrations and lists the
usernames. You can view the page and view the raw source code or a
syntax highlighted version. Forgive the messy code; it was written in
about ten minutes; the code around it isn’t really important. It is the
formlets themselves.</p>
<p><strong>UPDATE: 11 April 09:</strong> Also, I have an example of
using formlets in a real project with time constraints etc.</p>
<h2 id="summary">Summary</h2>
<p>I think I have covered, quite fully, the idea of formlets. Formlets
are composable pieces which contain (1) presentation, (2) validation,
(3) parsing, (4) success and (5) failure. Formlets are useful because
these five points are kept in one place and thus consistent, without any
manual ‘synching’. We can compose formlets, and a formlet’s definition
contains all the required information. We can customise the presentation
of existing formlets, or create our own new input methods. A
self-contained formlet can validate with and perform side-effects, in a
safe, composable manner. Formlets parse validated values into proper
program values (such as the Registration type). Formlets are an
excellent example of the kind of abstractions that Haskellers use all
the time.</p>
<h2 id="notes">Notes</h2>
<p>Please email me about any typing mistakes or inconsistencies that you
notice.</p>
<section id="footnotes" class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>Formlets, Parsec, Text.XHtml, the various monads, are
some of my favourite examples.<a href="#fnref1" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>This is a type, defined in Control.Applicative.Error,
with a definition that will make clear to you why it is used:</p>
<pre><code> data Failing a = Success a | Failure [ErrorMsg]</code></pre>
<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></li>
<li id="fn3"><p>Which I wrote in one go, compiled, and found that it
worked first time. I am clearly reaching Haskell Satori.<a
href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>One could easily leave it ambiguous, using the
NoMonomorphismRestriction pragma, thus allowing us to use register in
the IO monad, or the CGI monad, etc.<a href="#fnref4"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>“GHC supports overloaded string literals. Normally a
string literal has type String, but with overloaded string literals
enabled (with <code>-XOverloadedStrings</code>) a string literal has
type <code>(IsString a) =&gt;   a</code>.” See the GHC documentation for
<code>-XOverloadedStrings</code> for more information.<a href="#fnref5"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>


<footer>
  <table style="width:100%">
    <tr>
      <td>© 2008-11-14 <a href="/">Chris Done</a></td>
      <td style="text-align:right"><a href="/posts">Read more posts →</a></td>
    </tr>
  </table>
</footer>

    </div>
  </body>
</html>
